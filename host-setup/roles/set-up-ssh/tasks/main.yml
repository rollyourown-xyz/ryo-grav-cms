---
#-----------------------------------------------------------------------------------------------------------------------------------
# Use of 2FA is recommended for SSH access via public internet but requires additional preparation before host configuration
# See documentation at https://rollyourown.xyz/ ...

#### TODO Link needs completing ^^^ 

#-----------------------------------------------------------------------------------------------------------------------------------


# Install google-authenticator PAM module if the value of the variable host_non_root_use_google_authenticator in host_configuration.yml is true,
# otherwise skip
#
- name: Install libpam-google-authenticator
  apt:
    name: libpam-google-authenticator
    update_cache: yes
    state: present
  register: changes_made
  when: host_non_root_use_google_authenticator


# Copy .google-authenticator configuration file for non-root user if the value of the variable
# host_non_root_use_google_authenticator in host_configuration.yml is true - see documentation linked above
#
- name: Copy google-authenticator configuration file
  copy:
    mode: 0400
    owner: "{{ host_non_root_user }}"
    group: "{{ host_non_root_user }}"
    dest: "/home/{{ host_non_root_user }}/.google_authenticator"
    src: "{{ host_non_root_user_google_authenticator_file }}"
    force: yes
  register: changes_made
  when: host_non_root_use_google_authenticator


#-----------------------------------------------------------------------------------------------------------------------------------
# Change the SSH port, disable SSH password authentication, disallow root login and allow only the non-root user to log in via SSH
# Optionally, enable 2FA for SSH login via the public internet. 2FA is not required for login via a wireguard tunnel so that further
# automation tools (packer, terraform) can use SSH access without manual intervention
#-----------------------------------------------------------------------------------------------------------------------------------

# Change the SSH port
#
- name: Change the SSH port
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^#Port'
    line: "Port {{ host_new_ssh_port }}"


# Disable SSH password authentication
#
- name: Disable SSH password authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^(# *)?PasswordAuthentication'
    line: 'PasswordAuthentication no'


# Disallow root login
#
- name: Disallow root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^(# *)?PermitRootLogin'
    line: 'PermitRootLogin no'


# Allow only the non-root user to log in via SSH
#
- name: Allow only the non-root user to log in via SSH
  lineinfile:
    path: /etc/ssh/sshd_config
    line: "AllowUsers {{ host_non_root_user }}"


# Set ChallengeResponseAuthentication in SSH config file (no 2FA)
#
- name: Set ChallengeResponseAuthentication in SSH config file (no 2FA)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^(# *)?ChallengeResponseAuthentication'
    line: 'ChallengeResponseAuthentication no'
  when: not host_non_root_use_google_authenticator


# Set ChallengeResponseAuthentication in SSH config file (2FA)
#
- name: Set ChallengeResponseAuthentication in SSH config file (2FA)
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^(# *)?ChallengeResponseAuthentication'
    line: 'ChallengeResponseAuthentication yes'
  when: host_non_root_use_google_authenticator


# Set authentication methods for 2FA
#
- name: Set authentication methods for 2FA
  lineinfile:
    path: /etc/ssh/sshd_config
    insertafter: '^UsePAM yes'
    line: 'AuthenticationMethods publickey,password publickey,keyboard-interactive'
  when: host_non_root_use_google_authenticator


# Allow 2FA-less login via wireguard interface (2FA)
#
- name: Allow 2FA-less login via wireguard interface (2FA)
  blockinfile:
    path: /etc/ssh/sshd_config
    insertafter: EOF
    marker: "# {mark} ANSIBLE MANAGED BLOCK"
    block: |
      Match Address {{ host_wireguard_address_range }}
        AuthenticationMethods publickey
    state: present
  when: host_non_root_use_google_authenticator


# Set PAM to use pam_google_authenticator (2FA) 
#
- name: Set PAM to use pam_google_authenticator (2FA)
  lineinfile:
    path: /etc/pam.d/sshd
    line: 'auth required pam_google_authenticator.so'
  when: host_non_root_use_google_authenticator


# Exclude common-auth (2FA) 
#
- name: Exclude common-auth (2FA)
  lineinfile:
    path: /etc/pam.d/sshd
    regexp: '^@include common-auth'
    line: '# @include common-auth'
  when: host_non_root_use_google_authenticator





# # For 2FA, copy PAM sshd configuration file if the value of the variable host_non_root_use_google_authenticator
# # in host_configuration.yml is true - see documentation linked above
# #
# - name: Replace pam.d sshd configuration file (2FA)
#   copy:
#     mode: 0644
#     owner: root
#     group: root
#     dest: /etc/pam.d/sshd
#     src: sshd_2FA
#     force: yes
#   register: changes_made
#   when: host_non_root_use_google_authenticator

# # For no 2FA, copy PAM sshd configuration file if the value of the variable host_non_root_use_google_authenticator
# # in host_configuration.yml is true - see documentation linked above
# #
# - name: Replace pam.d sshd configuration file (non-2FA)
#   copy:
#     mode: 0644
#     owner: root
#     group: root
#     dest: /etc/pam.d/sshd
#     src: sshd_no_2FA
#     force: yes
#   register: changes_made
#   when: not host_non_root_use_google_authenticator


# # For 2FA, copy sshd_config file (2FA version) from template if the value of the variable host_non_root_use_google_authenticator
# # in host_configuration.yml is **true** - see documentation linked above
# # 
# - name: Replace sshd_config configuration file (2FA)
#   template:
#     mode: 0644
#     owner: root
#     group: root
#     dest: /etc/ssh/sshd_config
#     src: sshd_config_2FA.j2
#     force: yes
#     validate: /usr/sbin/sshd -t -f %s
#     backup: yes
#   register: changes_made
#   when: host_non_root_use_google_authenticator


# # For no 2FA, copy sshd_config file (non-2FA version) from template  if the value of the variable host_non_root_use_google_authenticator
# # in host_configuration.yml is **false**
# # 
# - name: Replace sshd_config configuration file (non-2FA)
#   template:
#     mode: 0644
#     owner: root
#     group: root
#     dest: /etc/ssh/sshd_config
#     src: sshd_config_no_2FA.j2
#     force: yes
#     validate: /usr/sbin/sshd -t -f %s
#     backup: yes
#   register: changes_made
#   when: not host_non_root_use_google_authenticator
